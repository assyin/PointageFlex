'use client';

import { useState, useMemo } from 'react';
import {
  Clock,
  Calendar,
  Download,
  FileDown,
  Plus,
  Search,
  ChevronDown,
  Upload,
  X,
  ArrowRight,
  User,
  CheckCircle,
  AlertCircle,
  Filter,
  FileText,
  Loader2,
} from 'lucide-react';
import {
  useOvertimeRecords,
  useApproveOvertime,
  useRejectOvertime,
  useConvertToRecovery,
  useOvertimeSummary
} from '@/lib/hooks/useOvertime';

// Types
type OvertimeStatus =
  | 'PENDING'
  | 'MANAGER_APPROVED'
  | 'HR_APPROVED'
  | 'APPROVED'
  | 'REJECTED'
  | 'PAID'
  | 'CONVERTED_TO_RECOVERY';

type OvertimeSource = 'BIOMETRIC' | 'MANUAL' | 'IMPORT' | 'QR_CODE' | 'MOBILE_GPS';

interface OvertimeRecord {
  id: string;
  employee: {
    name: string;
    department: string;
    site: string;
  };
  date: string;
  timeRange: string;
  hours: number;
  rate?: string;
  shift: string;
  shiftContext: string;
  source: OvertimeSource;
  sourceDetail: string;
  status: OvertimeStatus;
  statusPrimary: string;
  statusSecondary?: string;
  recoveryInfo?: string;
  isGroupRequest?: boolean;
  employeeCount?: number;
}

interface EmployeeOvertimeSummary {
  totalRecorded: string;
  convertedToPay: string;
  convertedToRecovery: string;
  remainingCredit: string;
  plannedRecoveryDays: string;
}

export default function OvertimePage() {
  // States
  const [activeTab, setActiveTab] = useState<'pending' | 'validated' | 'history'>('pending');
  const [showNewRecoveryPanel, setShowNewRecoveryPanel] = useState(false);
  const [selectedEmployee, setSelectedEmployee] = useState<string>('');
  const [periodFilter, setPeriodFilter] = useState('current_week');
  const [serviceFilter, setServiceFilter] = useState('all');
  const [shiftFilter, setShiftFilter] = useState('all');
  const [searchQuery, setSearchQuery] = useState('');
  const [formData, setFormData] = useState({
    employeeId: '',
    recoveryType: 'compensatory',
    recoveryDate: '',
    timeSlot: '',
    hoursToConsume: '',
    linkedOvertimeIds: [] as string[],
    comment: '',
    notifyManager: true,
    blockOvertimeDuringRecovery: false,
  });
  const [attachmentFile, setAttachmentFile] = useState<File | null>(null);

  // API Hooks
  const overtimeFilters = useMemo(() => {
    const filters: any = {};

    // Map activeTab to status filter
    if (activeTab === 'pending') {
      filters.status = 'PENDING';
    } else if (activeTab === 'validated') {
      filters.status = 'APPROVED';
    }

    // Add date range based on period filter
    const now = new Date();
    if (periodFilter === 'current_week') {
      const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
      filters.startDate = startOfWeek.toISOString().split('T')[0];
    } else if (periodFilter === 'last_week') {
      const startOfLastWeek = new Date(now.setDate(now.getDate() - now.getDay() - 7));
      filters.startDate = startOfLastWeek.toISOString().split('T')[0];
      const endOfLastWeek = new Date(now.setDate(now.getDate() - now.getDay() + 6));
      filters.endDate = endOfLastWeek.toISOString().split('T')[0];
    } else if (periodFilter === 'current_month') {
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      filters.startDate = startOfMonth.toISOString().split('T')[0];
    } else if (periodFilter === 'current_quarter') {
      const quarter = Math.floor(now.getMonth() / 3);
      const startOfQuarter = new Date(now.getFullYear(), quarter * 3, 1);
      filters.startDate = startOfQuarter.toISOString().split('T')[0];
    }

    return filters;
  }, [activeTab, periodFilter]);

  const { data: overtimeData, isLoading, error } = useOvertimeRecords(overtimeFilters);
  const { data: summaryData } = useOvertimeSummary(selectedEmployee);
  const approveOvertime = useApproveOvertime();
  const rejectOvertime = useRejectOvertime();
  const convertToRecovery = useConvertToRecovery();

  // Handle actions
  const handleApprove = async (id: string) => {
    await approveOvertime.mutateAsync(id);
  };

  const handleReject = async (id: string) => {
    const reason = prompt('Raison du rejet:');
    if (reason) {
      await rejectOvertime.mutateAsync({ id, reason });
    }
  };

  const handleConvertToRecovery = async (id: string) => {
    await convertToRecovery.mutateAsync(id);
  };

  // Transform API data to component format
  const overtimeRecords: OvertimeRecord[] = overtimeData?.data?.map((record: any) => ({
    id: record.id,
    employee: {
      name: record.employee?.firstName + ' ' + record.employee?.lastName || 'Unknown',
      department: record.employee?.department || 'N/A',
      site: record.employee?.site || 'N/A',
    },
    date: new Date(record.date).toLocaleDateString('fr-FR'),
    timeRange: `${record.startTime || ''} → ${record.endTime || ''}`,
    hours: record.hours,
    rate: record.rate ? `Taux ${record.rate * 100}%` : undefined,
    shift: record.type,
    shiftContext: record.notes || '',
    source: record.source,
    sourceDetail: record.source,
    status: record.status,
    statusPrimary: getStatusLabel(record.status),
    statusSecondary: getSecondaryStatusLabel(record.status),
    recoveryInfo: record.convertedToRecovery ? 'Converti en récupération' : '',
  })) || [];

  // Mock data - Overtime records (fallback)
  const mockOvertimeRecords: OvertimeRecord[] = [
    {
      id: '1',
      employee: {
        name: 'Imane Berrada',
        department: 'Accueil',
        site: 'Siège Casablanca',
      },
      date: '12/02/2024',
      timeRange: '19:00 → 21:30',
      hours: 2.5,
      rate: 'Taux 125%',
      shift: 'Soir',
      shiftContext: 'H5 après shift',
      source: 'BIOMETRIC',
      sourceDetail: 'Biométrie\nPointeuse - Portail 1',
      status: 'MANAGER_APPROVED',
      statusPrimary: 'Validé manager',
      statusSecondary: 'En attente RH',
      recoveryInfo: 'Proposer repos le\n19/02 (matin)',
    },
    {
      id: '2',
      employee: {
        name: 'Youssef Benali',
        department: 'Production',
        site: 'Site Tanger',
      },
      date: '11/02/2024',
      timeRange: '08:00 → 11:00',
      hours: 3,
      rate: 'Dimanche',
      shift: 'Matin',
      shiftContext: 'Jour férié',
      source: 'QR_CODE',
      sourceDetail: 'QR Code',
      status: 'PENDING',
      statusPrimary: 'À valider manager',
      recoveryInfo: 'Éligibilité récupération : Oui\n(3 h)',
    },
    {
      id: '3',
      employee: {
        name: 'Khadija El Amrani',
        department: 'Logistique',
        site: 'Site Casablanca',
      },
      date: '10/02/2024',
      timeRange: '22:00 → 00:00',
      hours: 2,
      rate: 'Nuit',
      shift: 'Nuit',
      shiftContext: 'H5 fin de shift',
      source: 'MOBILE_GPS',
      sourceDetail: 'Mobile - GPS',
      status: 'PAID',
      statusPrimary: 'Validé RH',
      statusSecondary: 'Temps paié',
      recoveryInfo: 'Converti en paie (pas de\nrepos)',
    },
    {
      id: '4',
      employee: {
        name: 'Équipe Logistique - Matin',
        department: 'Demande groupée',
        site: '',
      },
      date: '08/02/2024',
      timeRange: '07:00 → 08:30',
      hours: 1.5,
      shift: 'Matin',
      shiftContext: 'Charge\nexceptionnelle',
      source: 'IMPORT',
      sourceDetail: 'Import fichier',
      status: 'HR_APPROVED',
      statusPrimary: 'En attente RH',
      recoveryInfo: 'Planifier repos groupé',
      isGroupRequest: true,
      employeeCount: 12,
    },
  ];

  // Helper functions for status labels
  const getStatusLabel = (status: string): string => {
    const labels: Record<string, string> = {
      PENDING: 'À valider',
      APPROVED: 'Approuvé',
      REJECTED: 'Rejeté',
      PAID: 'Payé',
      RECOVERED: 'Récupéré',
      MANAGER_APPROVED: 'Validé manager',
      HR_APPROVED: 'Validé RH',
    };
    return labels[status] || status;
  };

  const getSecondaryStatusLabel = (status: string): string | undefined => {
    if (status === 'MANAGER_APPROVED') return 'En attente RH';
    if (status === 'PAID') return 'Temps payé';
    return undefined;
  };

  // Use API data or fallback to mock data
  const displayRecords = overtimeData?.data ? overtimeRecords : mockOvertimeRecords;
  const totalCount = overtimeData?.total || displayRecords.length;

  // Mock employee summary (use API data when available)
  const employeeSummary: EmployeeOvertimeSummary = summaryData || {
    totalRecorded: '42 h 15 min',
    convertedToPay: '28 h 00 min',
    convertedToRecovery: '10 h 00 min',
    remainingCredit: '4 h 15 min',
    plannedRecoveryDays: '2 demi-journées',
  };

  // Status badge component
  const StatusBadge = ({ status, label, isSecondary = false }: { status: OvertimeStatus; label: string; isSecondary?: boolean }) => {
    const getStatusStyles = () => {
      if (isSecondary) {
        switch (status) {
          case 'HR_APPROVED':
          case 'MANAGER_APPROVED':
            return 'bg-orange-100 text-orange-800 border-orange-200';
          case 'PAID':
            return 'bg-gray-100 text-gray-800 border-gray-200';
          default:
            return 'bg-gray-100 text-gray-800 border-gray-200';
        }
      }

      switch (status) {
        case 'APPROVED':
        case 'MANAGER_APPROVED':
          return 'bg-green-100 text-green-800 border-green-200';
        case 'HR_APPROVED':
          return 'bg-teal-100 text-teal-800 border-teal-200';
        case 'PENDING':
          return 'bg-orange-100 text-orange-800 border-orange-200';
        case 'PAID':
          return 'bg-green-100 text-green-800 border-green-200';
        case 'REJECTED':
          return 'bg-red-100 text-red-800 border-red-200';
        default:
          return 'bg-gray-100 text-gray-800 border-gray-200';
      }
    };

    return (
      <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${getStatusStyles()}`}>
        {label}
      </span>
    );
  };

  return (
    <div className="min-h-screen bg-[#F8F9FA]">
      {/* Header */}
      <div className="bg-white border-b border-gray-200">
        <div className="max-w-[1600px] mx-auto px-6 py-6">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-[28px] font-bold text-[#212529]">Récupérations & Heures supplémentaires</h1>
              <p className="text-[14px] text-[#6C757D] mt-1">
                Suivi des heures sup, droits à récupération et validations
              </p>
            </div>

            <div className="flex items-center gap-3">
              <button className="flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-300 text-[#212529] rounded-lg hover:bg-gray-50 transition-colors text-[14px] font-medium">
                <Download className="w-4 h-4" />
                Export Excel
              </button>

              <button className="flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-300 text-[#212529] rounded-lg hover:bg-gray-50 transition-colors text-[14px] font-medium">
                <FileDown className="w-4 h-4" />
                Export PDF
              </button>

              <button
                onClick={() => setShowNewRecoveryPanel(!showNewRecoveryPanel)}
                className="flex items-center gap-2 px-4 py-2.5 bg-[#0052CC] text-white rounded-lg hover:bg-[#0041A8] transition-colors text-[14px] font-semibold"
              >
                <Plus className="w-4 h-4" />
                Nouvelle demande de repos
              </button>

              <div className="flex items-center gap-3 ml-4 pl-4 border-l border-gray-200">
                <div className="w-10 h-10 rounded-full bg-[#0052CC] flex items-center justify-center text-white font-semibold">
                  RA
                </div>
                <div>
                  <div className="text-[14px] font-semibold text-[#212529]">Rania Admin</div>
                  <div className="text-[12px] text-[#6C757D]">Admin RH</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-[1600px] mx-auto px-6 py-6">
        <div className="flex gap-6">
          {/* Left Section - Overtime Records List */}
          <div className={`${showNewRecoveryPanel ? 'flex-1' : 'w-full'} transition-all duration-300`}>
            <div className="bg-white rounded-lg border border-gray-200">
              {/* Filters */}
              <div className="p-6 border-b border-gray-200">
                <div className="flex items-center gap-3 mb-4">
                  <Filter className="w-5 h-5 text-[#6C757D]" />
                  <span className="text-[14px] font-semibold text-[#212529]">Filtrer</span>
                </div>

                <div className="grid grid-cols-4 gap-4 mb-4">
                  <div>
                    <label className="block text-[12px] text-[#6C757D] mb-1.5">
                      Période : <span className="text-[#212529] font-medium">Semaine en cours</span>
                    </label>
                    <select
                      value={periodFilter}
                      onChange={(e) => setPeriodFilter(e.target.value)}
                      className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-[14px] text-[#212529] focus:outline-none focus:ring-2 focus:ring-[#0052CC] focus:border-transparent"
                    >
                      <option value="current_week">Semaine en cours</option>
                      <option value="last_week">Semaine dernière</option>
                      <option value="current_month">Mois en cours</option>
                      <option value="current_quarter">Trimestre en cours</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-[12px] text-[#6C757D] mb-1.5">
                      Service : <span className="text-[#212529] font-medium">Tous</span>
                    </label>
                    <select
                      value={serviceFilter}
                      onChange={(e) => setServiceFilter(e.target.value)}
                      className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-[14px] text-[#212529] focus:outline-none focus:ring-2 focus:ring-[#0052CC] focus:border-transparent"
                    >
                      <option value="all">Tous</option>
                      <option value="accueil">Accueil</option>
                      <option value="production">Production</option>
                      <option value="logistique">Logistique</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-[12px] text-[#6C757D] mb-1.5">
                      Shift : <span className="text-[#212529] font-medium">Tous</span>
                    </label>
                    <select
                      value={shiftFilter}
                      onChange={(e) => setShiftFilter(e.target.value)}
                      className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-[14px] text-[#212529] focus:outline-none focus:ring-2 focus:ring-[#0052CC] focus:border-transparent"
                    >
                      <option value="all">Tous</option>
                      <option value="morning">Matin</option>
                      <option value="evening">Soir</option>
                      <option value="night">Nuit</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-[12px] text-[#6C757D] mb-1.5 opacity-0">
                      Search
                    </label>
                    <div className="relative">
                      <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-[#6C757D]" />
                      <input
                        type="text"
                        placeholder="Rechercher par employé, site, statut..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        className="w-full pl-10 pr-4 py-2 bg-white border border-gray-300 rounded-lg text-[14px] placeholder:text-[#6C757D] focus:outline-none focus:ring-2 focus:ring-[#0052CC] focus:border-transparent"
                      />
                    </div>
                  </div>
                </div>
              </div>

              {/* Overtime records section */}
              <div className="p-6">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h2 className="text-[20px] font-semibold text-[#212529]">Heures supplémentaires enregistrées</h2>
                    <p className="text-[14px] text-[#6C757D] mt-0.5">
                      Issues des pointages et des validations managers
                    </p>
                  </div>

                  <div className="text-[14px] text-[#212529]">
                    {isLoading ? (
                      <Loader2 className="w-4 h-4 animate-spin" />
                    ) : (
                      <>
                        <span className="font-semibold">{totalCount}</span> lignes cette semaine
                      </>
                    )}
                  </div>
                </div>

                {/* Tabs */}
                <div className="flex items-center gap-2 mb-4">
                  <button
                    onClick={() => setActiveTab('pending')}
                    className={`px-4 py-2 rounded-lg text-[14px] font-medium transition-colors ${
                      activeTab === 'pending'
                        ? 'bg-[#0052CC] text-white'
                        : 'bg-gray-100 text-[#6C757D] hover:bg-gray-200'
                    }`}
                  >
                    À valider
                  </button>
                  <button
                    onClick={() => setActiveTab('validated')}
                    className={`px-4 py-2 rounded-lg text-[14px] font-medium transition-colors ${
                      activeTab === 'validated'
                        ? 'bg-[#0052CC] text-white'
                        : 'bg-gray-100 text-[#6C757D] hover:bg-gray-200'
                    }`}
                  >
                    Validées & planifiées
                  </button>
                  <button
                    onClick={() => setActiveTab('history')}
                    className={`px-4 py-2 rounded-lg text-[14px] font-medium transition-colors ${
                      activeTab === 'history'
                        ? 'bg-[#0052CC] text-white'
                        : 'bg-gray-100 text-[#6C757D] hover:bg-gray-200'
                    }`}
                  >
                    Historique 3 mois
                  </button>
                </div>

                {/* Table */}
                <div className="overflow-x-auto">
                  {isLoading ? (
                    <div className="flex items-center justify-center py-12">
                      <Loader2 className="w-8 h-8 animate-spin text-[#0052CC]" />
                    </div>
                  ) : error ? (
                    <div className="flex items-center justify-center py-12 text-red-600">
                      <AlertCircle className="w-5 h-5 mr-2" />
                      Erreur lors du chargement des données
                    </div>
                  ) : displayRecords.length === 0 ? (
                    <div className="flex items-center justify-center py-12 text-[#6C757D]">
                      Aucune donnée disponible
                    </div>
                  ) : (
                    <table className="w-full">
                      <thead>
                        <tr className="bg-[#F1F3F5] border-b border-[#DEE2E6]">
                          <th className="text-left px-4 py-3 text-[14px] font-semibold text-[#212529]">Employé</th>
                          <th className="text-left px-4 py-3 text-[14px] font-semibold text-[#212529]">Date</th>
                          <th className="text-left px-4 py-3 text-[14px] font-semibold text-[#212529]">Heures</th>
                          <th className="text-left px-4 py-3 text-[14px] font-semibold text-[#212529]">Shift</th>
                          <th className="text-left px-4 py-3 text-[14px] font-semibold text-[#212529]">Source</th>
                          <th className="text-left px-4 py-3 text-[14px] font-semibold text-[#212529]">Statut</th>
                          <th className="text-left px-4 py-3 text-[14px] font-semibold text-[#212529]">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {displayRecords.map((record) => (
                        <tr
                          key={record.id}
                          className="border-b border-[#DEE2E6] hover:bg-[#E9ECEF] transition-colors cursor-pointer"
                        >
                          <td className="px-4 py-4">
                            <div>
                              <div className="text-[14px] font-semibold text-[#212529]">
                                {record.employee.name}
                              </div>
                              <div className="text-[12px] text-[#6C757D]">
                                {record.employee.department}
                                {record.employee.site && ` - ${record.employee.site}`}
                              </div>
                            </div>
                          </td>
                          <td className="px-4 py-4">
                            <div>
                              <div className="text-[14px] text-[#212529] font-medium">
                                {record.date}
                              </div>
                              <div className="text-[12px] text-[#6C757D]">
                                {record.timeRange}
                              </div>
                            </div>
                          </td>
                          <td className="px-4 py-4">
                            <div>
                              <div className="text-[14px] text-[#212529] font-semibold">
                                {record.hours} h{record.isGroupRequest && ` x ${record.employeeCount} personnes`}
                              </div>
                              {record.rate && (
                                <div className="text-[12px] text-[#6C757D]">
                                  {record.rate}
                                </div>
                              )}
                            </div>
                          </td>
                          <td className="px-4 py-4">
                            <div>
                              <div className="text-[14px] text-[#212529] font-medium">
                                {record.shift}
                              </div>
                              <div className="text-[12px] text-[#6C757D] whitespace-pre-line">
                                {record.shiftContext}
                              </div>
                            </div>
                          </td>
                          <td className="px-4 py-4">
                            <div className="text-[13px] text-[#212529] whitespace-pre-line">
                              {record.sourceDetail}
                            </div>
                          </td>
                          <td className="px-4 py-4">
                            <div className="space-y-1">
                              <StatusBadge status={record.status} label={record.statusPrimary} />
                              {record.statusSecondary && (
                                <div>
                                  <StatusBadge status={record.status} label={record.statusSecondary} isSecondary />
                                </div>
                              )}
                            </div>
                          </td>
                          <td className="px-4 py-4">
                            <div className="text-[13px] text-[#212529] whitespace-pre-line">
                              {record.recoveryInfo}
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                {/* Warning Alert */}
                <div className="mt-6 bg-[#FFC107] bg-opacity-10 border border-[#FFC107] rounded-lg p-4 flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <AlertCircle className="w-5 h-5 text-[#FFC107]" />
                    <span className="text-[14px] text-[#212529]">
                      <span className="font-semibold">5 lignes d'heures sup</span> en attente de validation depuis plus de <span className="font-semibold">7 jours</span>.
                    </span>
                  </div>
                  <button className="px-4 py-2 bg-white border border-gray-300 text-[#212529] rounded-lg hover:bg-gray-50 transition-colors text-[14px] font-medium">
                    Relancer les managers
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* Right Panel - New Recovery Request Form */}
          {showNewRecoveryPanel && (
            <div className="w-[480px] space-y-4">
              {/* Form Card */}
              <div className="bg-white rounded-lg border border-gray-200">
                <div className="p-6 border-b border-gray-200">
                  <div className="flex items-start justify-between mb-2">
                    <div className="flex-1">
                      <h3 className="text-[18px] font-semibold text-[#212529]">
                        Nouvelle demande de repos / récupération
                      </h3>
                      <p className="text-[13px] text-[#6C757D] mt-1">
                        Au nom d'un employé ou d'une équipe
                      </p>
                    </div>
                    <button
                      onClick={() => setShowNewRecoveryPanel(false)}
                      className="text-[#6C757D] hover:text-[#212529]"
                    >
                      <X className="w-5 h-5" />
                    </button>
                  </div>
                  <div className="inline-flex items-center gap-2 px-3 py-1 bg-blue-50 border border-blue-200 rounded-full text-[12px] text-blue-800 font-medium">
                    Heures sup éligibles
                  </div>
                </div>

                <div className="p-6 space-y-4">
                  {/* Employee/Team Select */}
                  <div>
                    <label className="block text-[14px] font-medium text-[#212529] mb-1.5">
                      Employé ou équipe
                    </label>
                    <div className="relative">
                      <select
                        value={formData.employeeId}
                        onChange={(e) => {
                          setFormData({ ...formData, employeeId: e.target.value });
                          setSelectedEmployee(e.target.value);
                        }}
                        className="w-full px-3 py-2.5 bg-white border border-gray-300 rounded-lg text-[14px] text-[#212529] focus:outline-none focus:ring-2 focus:ring-[#0052CC] focus:border-transparent appearance-none"
                      >
                        <option value="">Sélectionner un employé ou une équipe</option>
                        <option value="emp1">Imane Berrada</option>
                        <option value="emp2">Youssef Benali</option>
                        <option value="emp3">Khadija El Amrani</option>
                        <option value="team1">Équipe Logistique - Matin</option>
                      </select>
                      <ChevronDown className="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-[#6C757D] pointer-events-none" />
                    </div>
                  </div>

                  {/* Recovery Type & Available Credit */}
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-[14px] font-medium text-[#212529] mb-1.5">
                        Type de récupération
                      </label>
                      <div className="px-3 py-2.5 bg-gray-50 border border-gray-300 rounded-lg text-[14px] text-[#212529]">
                        Repos compensateur
                      </div>
                    </div>
                    <div>
                      <label className="block text-[14px] font-medium text-[#212529] mb-1.5">
                        Crédit disponible
                      </label>
                      <div className="px-3 py-2.5 bg-green-50 border border-green-300 rounded-lg text-[14px] text-green-800 font-semibold">
                        7 h 30 min
                      </div>
                    </div>
                  </div>

                  {/* Recovery Date & Time Slot */}
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-[14px] font-medium text-[#212529] mb-1.5">
                        Date du repos
                      </label>
                      <input
                        type="date"
                        value={formData.recoveryDate}
                        onChange={(e) => setFormData({ ...formData, recoveryDate: e.target.value })}
                        placeholder="JJ/MM/AAAA"
                        className="w-full px-3 py-2.5 bg-white border border-gray-300 rounded-lg text-[14px] text-[#212529] focus:outline-none focus:ring-2 focus:ring-[#0052CC] focus:border-transparent"
                      />
                    </div>
                    <div>
                      <label className="block text-[14px] font-medium text-[#212529] mb-1.5">
                        Plage horaire
                      </label>
                      <div className="relative">
                        <select
                          value={formData.timeSlot}
                          onChange={(e) => setFormData({ ...formData, timeSlot: e.target.value })}
                          className="w-full px-3 py-2.5 bg-white border border-gray-300 rounded-lg text-[14px] text-[#212529] focus:outline-none focus:ring-2 focus:ring-[#0052CC] focus:border-transparent appearance-none"
                        >
                          <option value="">Sélectionner</option>
                          <option value="morning">Matin (08:00 → 12:00)</option>
                          <option value="afternoon">Après-midi (14:00 → 18:00)</option>
                          <option value="full_day">Journée complète</option>
                        </select>
                        <ChevronDown className="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-[#6C757D] pointer-events-none" />
                      </div>
                    </div>
                  </div>

                  {/* Hours to Consume & Linked Overtime */}
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-[14px] font-medium text-[#212529] mb-1.5">
                        Heures à consommer
                      </label>
                      <input
                        type="text"
                        value={formData.hoursToConsume}
                        onChange={(e) => setFormData({ ...formData, hoursToConsume: e.target.value })}
                        placeholder="4 h"
                        className="w-full px-3 py-2.5 bg-white border border-gray-300 rounded-lg text-[14px] placeholder:text-[#6C757D] focus:outline-none focus:ring-2 focus:ring-[#0052CC] focus:border-transparent"
                      />
                    </div>
                    <div>
                      <label className="block text-[14px] font-medium text-[#212529] mb-1.5">
                        Lien avec heures sup
                      </label>
                      <button className="w-full px-3 py-2.5 bg-white border border-gray-300 rounded-lg text-[14px] text-[#6C757D] hover:border-[#0052CC] transition-colors text-left">
                        Sélectionner les lignes...
                      </button>
                    </div>
                  </div>

                  {/* Comment */}
                  <div>
                    <label className="block text-[14px] font-medium text-[#212529] mb-1.5">
                      Commentaire
                    </label>
                    <textarea
                      value={formData.comment}
                      onChange={(e) => setFormData({ ...formData, comment: e.target.value })}
                      placeholder="Ex : Récupération suite aux heures sup du week-end du 10/02..."
                      rows={3}
                      className="w-full px-3 py-2.5 bg-white border border-gray-300 rounded-lg text-[14px] placeholder:text-[#6C757D] focus:outline-none focus:ring-2 focus:ring-[#0052CC] focus:border-transparent resize-none"
                    />
                  </div>

                  {/* Attachment */}
                  <div>
                    <label className="block text-[14px] font-medium text-[#212529] mb-1.5">
                      Justificatif (optionnel)
                    </label>
                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-[#0052CC] transition-colors cursor-pointer">
                      <input
                        type="file"
                        id="recovery-attachment"
                        className="hidden"
                        accept=".pdf,.jpg,.jpeg,.png"
                        onChange={(e) => setAttachmentFile(e.target.files?.[0] || null)}
                      />
                      <label htmlFor="recovery-attachment" className="cursor-pointer">
                        <Upload className="w-6 h-6 text-[#6C757D] mx-auto mb-2" />
                        <div className="text-[14px] text-[#212529] font-medium">
                          Importer un fichier
                        </div>
                        <div className="text-[12px] text-[#6C757D] mt-1">
                          PDF, JPG ou PNG, max 5 Mo
                        </div>
                      </label>
                    </div>
                    {attachmentFile && (
                      <div className="mt-2 flex items-center gap-2 text-[13px] text-[#212529]">
                        <FileText className="w-4 h-4" />
                        {attachmentFile.name}
                        <button
                          onClick={() => setAttachmentFile(null)}
                          className="ml-auto text-red-600 hover:text-red-700"
                        >
                          <X className="w-4 h-4" />
                        </button>
                      </div>
                    )}
                  </div>

                  {/* Checkboxes */}
                  <div className="space-y-2">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={formData.notifyManager}
                        onChange={(e) => setFormData({ ...formData, notifyManager: e.target.checked })}
                        className="w-4 h-4 rounded border-gray-300 text-[#0052CC] focus:ring-[#0052CC]"
                      />
                      <span className="text-[14px] text-[#212529]">Notifier le manager pour validation</span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={formData.blockOvertimeDuringRecovery}
                        onChange={(e) => setFormData({ ...formData, blockOvertimeDuringRecovery: e.target.checked })}
                        className="w-4 h-4 rounded border-gray-300 text-[#0052CC] focus:ring-[#0052CC]"
                      />
                      <span className="text-[14px] text-[#212529]">Bloquer la prise d'heures sup pendant ce repos</span>
                    </label>
                  </div>

                  {/* Action Buttons */}
                  <div className="flex gap-3 pt-4">
                    <button
                      onClick={() => setShowNewRecoveryPanel(false)}
                      className="flex-1 px-4 py-2.5 bg-white border border-gray-300 text-[#212529] rounded-lg hover:bg-gray-50 transition-colors text-[14px] font-medium"
                    >
                      Annuler
                    </button>
                    <button className="flex-1 px-4 py-2.5 bg-[#0052CC] text-white rounded-lg hover:bg-[#0041A8] transition-colors text-[14px] font-semibold">
                      Envoyer pour validation
                    </button>
                  </div>
                </div>
              </div>

              {/* Workflow Card */}
              <div className="bg-white rounded-lg border border-gray-200">
                <div className="p-6">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-[16px] font-semibold text-[#212529]">
                      Workflow de validation - Récupérations
                    </h3>
                    <span className="px-2.5 py-1 bg-green-100 text-green-800 text-[11px] font-semibold rounded-full">
                      Automatisé
                    </span>
                  </div>
                  <p className="text-[13px] text-[#6C757D] mb-6">
                    Aligné avec les règles paie & temps de travail
                  </p>

                  {/* Workflow Steps */}
                  <div className="space-y-4">
                    {/* Step 1: Employee/RH */}
                    <div className="flex gap-4">
                      <div className="flex flex-col items-center">
                        <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                          <User className="w-5 h-5 text-[#0052CC]" />
                        </div>
                        <div className="w-0.5 h-12 bg-gray-200 my-1"></div>
                      </div>
                      <div className="flex-1 pt-2">
                        <div className="text-[14px] font-semibold text-[#212529]">Employé / RH</div>
                        <div className="text-[13px] text-[#6C757D] mt-0.5">
                          Propose le repos et sélectionne les heures sup à consommer.
                        </div>
                      </div>
                    </div>

                    {/* Step 2: Manager */}
                    <div className="flex gap-4">
                      <div className="flex flex-col items-center">
                        <div className="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center">
                          <CheckCircle className="w-5 h-5 text-[#FFC107]" />
                        </div>
                        <div className="w-0.5 h-12 bg-gray-200 my-1"></div>
                      </div>
                      <div className="flex-1 pt-2">
                        <div className="text-[14px] font-semibold text-[#212529]">Manager</div>
                        <div className="text-[13px] text-[#6C757D] mt-0.5">
                          Valide la date, la durée et l'impact sur le planning.
                        </div>
                      </div>
                    </div>

                    {/* Step 3: RH/Paie */}
                    <div className="flex gap-4">
                      <div className="flex flex-col items-center">
                        <div className="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                          <CheckCircle className="w-5 h-5 text-[#28A745]" />
                        </div>
                      </div>
                      <div className="flex-1 pt-2">
                        <div className="text-[14px] font-semibold text-[#212529]">RH / Paie</div>
                        <div className="text-[13px] text-[#6C757D] mt-0.5">
                          Contrôle la conformité et envoie vers paie si nécessaire.
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="mt-6 pt-4 border-t border-gray-200">
                    <p className="text-[12px] text-[#6C757D] leading-relaxed">
                      Les repos validés sont automatiquement reflétés dans le planning et les reports paie.
                    </p>
                    <button className="text-[13px] text-[#0052CC] hover:underline font-medium mt-2">
                      Voir les règles d'entreprise
                    </button>
                  </div>
                </div>
              </div>

              {/* Employee Summary Card */}
              {selectedEmployee && (
                <div className="bg-white rounded-lg border border-gray-200">
                  <div className="p-6">
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="text-[16px] font-semibold text-[#212529]">
                        Synthèse Heures sup & Récupérations
                      </h3>
                      <div className="flex items-center gap-2">
                        <span className="text-[12px] text-[#6C757D]">Année</span>
                        <span className="text-[14px] font-semibold text-[#212529]">2024</span>
                      </div>
                    </div>
                    <p className="text-[13px] text-[#6C757D] mb-4">
                      Employé sélectionné
                    </p>
                    <div className="text-[11px] text-[#0052CC] font-medium mb-4">Mise à jour temps réel</div>

                    <div className="space-y-3">
                      <div className="flex justify-between items-center py-2 border-b border-gray-100">
                        <span className="text-[13px] text-[#6C757D]">Total heures sup enregistrées</span>
                        <span className="text-[14px] font-semibold text-[#212529]">
                          {employeeSummary.totalRecorded}
                        </span>
                      </div>
                      <div className="flex justify-between items-center py-2 border-b border-gray-100">
                        <span className="text-[13px] text-[#6C757D]">Heures sup converties en paie</span>
                        <span className="text-[14px] font-semibold text-[#212529]">
                          {employeeSummary.convertedToPay}
                        </span>
                      </div>
                      <div className="flex justify-between items-center py-2 border-b border-gray-100">
                        <span className="text-[13px] text-[#6C757D]">Heures sup converties en repos</span>
                        <span className="text-[14px] font-semibold text-[#212529]">
                          {employeeSummary.convertedToRecovery}
                        </span>
                      </div>
                      <div className="flex justify-between items-center py-2 border-b border-gray-100">
                        <span className="text-[13px] text-[#6C757D]">Crédit de récupération restant</span>
                        <span className="text-[14px] font-semibold text-[#28A745]">
                          {employeeSummary.remainingCredit}
                        </span>
                      </div>
                      <div className="flex justify-between items-center py-2">
                        <span className="text-[13px] text-[#6C757D]">Repos déjà planifiés</span>
                        <span className="text-[14px] font-semibold text-[#212529]">
                          {employeeSummary.plannedRecoveryDays}
                        </span>
                      </div>
                    </div>

                    <div className="mt-4 pt-4 border-t border-gray-200">
                      <p className="text-[11px] text-[#6C757D] leading-relaxed">
                        Les montants sont calculés à partir des pointages biométriques, des imports et des validations managers / RH.
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
